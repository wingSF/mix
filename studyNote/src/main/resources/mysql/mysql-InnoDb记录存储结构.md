# InnoDb记录存储结构
* InnoDb简介
    * 是一个将表数据存储在磁盘上的存储引擎，相对于`Memory`引擎
    * InnoDb从磁盘上读数据的时候，不是一条一条读的，是一次读一页，默认配置16KB，读到内存中。从内存刷到磁盘也是16KB
* InnoDb行格式
    * 记录在表中存储的方式是依据一定的格式存储的，这种格式称为行格式|记录格式
    * 已经问世的四种
        * Compact|Redundant|Dynamic|Compressed
    * 使用方式
        * create table | alter table ${table_name} ROW_FORMAT = 行格式名称
    * COMPACT
        * 适用于表级别
        * 记录的额外信息 + 记录的真实数据
            * 额外信息
                * 服务器为了描述这条记录而不得不额外添加的一些信息
                    * 变长字段 长度列表
                        * mysql中 varchar(M)、varbinary(M)、TEXT类型、BLOB类型等类型，我们称之为`变成字段`
                        > 是否被认为是变成字段  
                        第一取决于字符集，例如ascii是定长字符集，但gbk和utf8不是
                        第二取决于字段类型申明，varchar一定是变成，char不一定是固定长度
                        * 变长字段存储多少字节是不固定的，存储数据时，需要记录占用字节数
                        * 把所有变长字段的真实数据占用的字节长度都存放在记录的开头部分，从而形成一个变成字段长度列表，按照列顺序的逆序存放
                        * 占用字节计算之(W、M、L)
                            * `w`等于当前字符集在`show charset`中MaxLen的值，表示当前字符集下，一个字符使用多少字节表示
                            * `M`等于列声明时指定的长度，例如varchar(M)
                            * `L`表示当前数据实际存储占用真正字节数
                            * 所以在变长字段的长度列表里面（单列的情况）
                                * 如果`W`*`M`<=255，说明最大长度超不过1字节，使用1字节表示
                                * 当`W`*`M`>255
                                    * 如果`L`<=127，用1字节表示真正字符串占用的字节数
                                    * 如果`L`> 127，用2字节表示真正字符串占用的字节数
                            > Innodb在读取记录时，先查看表结构，如果某个变成字段允许存储不超过1个字节，使用1字节表示  
                            如果超过1个字节，通过当前字节的首位判断，当前读取的是一个字符还是半个字符，参照上面的127，多思考
                        * 只存储值为非NULL的列内容占用的长度，值为NULL的列的长度是不存储的
                        * 如果列都是固定长度的，则不存在变长字段列表                                    
                    * NULL值列表
                        * 主键&被not null修饰的列不会存储null值
                        * 每个允许 null的列 在 NULL值列表中占一个二进制位
                            * 这些列 按照 列出现顺序的逆序 排列在 NULL值列表中
                            * 值为1，表示该列为null
                            * 值为0，表示该列不为null
                        * mysql中的NULL值列表的长度，一定是整数个字节(8位)，不够的高位补0
                    * 记录头信息       
                        * 固定5个字节，40位
                        * 第一&第二位，预留位置，没有使用
                        * 第三位，标记该记录是否被删除
                        * 第四位，
                        * 第五->第八，表示当前记录拥有的记录数
                            * n_owned
                            * todo，啥意思？
                        * 第九->第二十一位，表示记录在记录堆的位置信息
                            * heap_no
                        * 第二十二->第二十四，表示记录的类型
                            * 0，普通记录
                            * 1，B+树非叶子结点记录
                            * 2，表示最小记录
                            * 3，表示最大记录
                            * todo，为啥用三位？想不开？
                        * 第二十五->第四十位，表示下一条记录的相对位置
            * 真实数据
                * 隐藏列
                    * 在真是数据区域，mysql会为每条记录添加一列隐藏列
                        * DB_ROW_ID
                            * 非必须，6字节，行ID
                            * InnoDB模式下，优先使用用户自定义主键作为主键
                            * 如果没有主键，选unique的列做主键
                            * 如果没有unique列，增加row_id
                            * todo,如何从行格式中得知是否有row_id?
                        * DB_TRX_ID
                            * 必须，6字节，事务ID
                        * DB_ROLL_PTR
                            * 必须，7字节，回滚指针
                * 定长字段，记录以外的空间使用，固定字符替换，char(10)，多余的使用空格字符填充
                * null值，不再占用真实数据的空间
    * redundant
        * mysql5.0之前的行格式
        * 记录的额外信息
            * 字段长度偏移列表
                * 会把所有列都按照逆序存储
                * 相邻俩个数值的差值，就是列占用的字节数
                    * 存储的值 是 列占用空间在 记录的真实数据 处 结束的位置
            * 记录头信息
                * 固定6字节，48个位
                    * 1，2预留位置
                    * 3，是否被删除标记
                    * 4
                    * 5,6,7,8， 当前记录拥有的记录数
                    * 9-21，在页面堆的位置信息
                    * 22-31，记录中列的数量
                    * 32，长度偏移列表中每个列对应的偏移量采用1字节还是2字节表示
                    > 对于超过2字节的，存储的时候，数据已经放到溢出页中了
                    * 33-49，下一条记录的相对位置
        * 记录的真实数据 
            * row_id
            * transaction_id
            * roll_pointer
            * 列内容
        * NULL值处理
            * 判断长度偏移列表中对应数值的第一位，如果是1，该列位NULL，不是1，不是NULL
            * 由于第一位被使用，所以真实数据超过127的时候，需要使用2字节表示
            * 如果列是字长字段，存储NULL值，会占用实际存储空间，如果是变成字段，不占用存储空间
        * char(M)
            * 占用空间 = 字符集表示一个字符所需最大字节数 * M
        * varchar(M)中，M的最大值
            * mysql规定，varchar(M),占用最多65535个字节
            > 一行中的所有列(包括应仓列和记录头信息)占用的字节长度加起来不能超过65535个字节，以varchar(M)举例  
            * 上述中包含隐藏列
                * 真实数据
                * 真实数据占用字节的长度
                * NULL值标识，如果列有NOT NULL，则不需要该标识              
            * 结论
                * ascii下，M最大65532，加not null ，65533
                * gbk下，M最大32766
                * utf8下，M最大21844    
        * 行溢出
            * mysql以页来管理存储空间，一页16KB，16384字节，如果一条记录超过来这个大小，就会出现一页存放不了一条记录
            * 在conpact和reduntant中，对于超长字段，在记录的真实数据处只会存储该列的一部分数据，其余数据分散存储在其他页中
                * 在`记录的真实数据`的最后位置，使用20字节存储其他页的地址
            * mysql规定一页至少存放俩条记录
    * Dynamic & Compressed
        * Dynamic是mysql5.7的默认行格式，于Compact类似
        * 处理溢出的时候，将所有数据都写到溢出页
        * Compressed会采用压缩算法对页面进行压缩，节省空间